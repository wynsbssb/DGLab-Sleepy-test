<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ env.page.title }}</title>
    <meta name="description" content="{{ env.page.desc }}">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> -->
    <link rel="icon" href="{{ env.page.favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <style>
        body {
            background: radial-gradient(circle at 20% 20%, rgba(79, 139, 255, 0.08), transparent 32%),
                        linear-gradient(180deg, rgba(15, 17, 21, 0.92), rgba(15, 17, 21, 0.96)),
                        url('{{ background_url }}') no-repeat center center fixed;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
    </style>

</head>

<body>
    <div class="container page-shell">
        <div class="card dashboard-card" id="user_status">
            <div class="dashboard-header">
                <div>
                    <p class="eyebrow">设备 + 应用使用统计</p>
                    <h1><ruby>似<rt>sǐ</rt></ruby>了吗?</h1>
                    <h3 class="subdued"><i><b>{{ env.page.user }}'s</b></i> Status:<br><a id="status">{{ status['name'] }}</a></h3>
                    <p id="additional-info">{{ status['desc'] | safe }}</p>
                </div>
                <div class="header-actions">
                    {% if env.page.moonlight %}
                    <!-- (moonlight) 透明度 / 暗色模式 -->
                    {% include "moonlight.html" %}
                    {% endif %}
                    {% if env.page.slider %}
                    <div id="slider"></div>
                    {% endif %}
                </div>
            </div>
            <!-- Dashboard top stats -->
            <div class="dashboard-top">
                <div id="top-stats" class="stat-row">
                    <div class="stat-card stat-blue" id="stat-app-count">
                        <div class="stat-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="8" height="8" rx="1.5" fill="#E6EEF3" opacity="0.15"/><rect x="13" y="3" width="8" height="8" rx="1.5" fill="#E6EEF3" opacity="0.25"/><rect x="3" y="13" width="8" height="8" rx="1.5" fill="#E6EEF3" opacity="0.2"/><rect x="13" y="13" width="8" height="8" rx="1.5" fill="#E6EEF3" opacity="0.22"/></svg>
                        </div>
                        <div class="stat-value">—</div>
                        <div class="stat-label">应用总数</div>
                    </div>
                    <div class="stat-card stat-green" id="stat-total-time">
                        <div class="stat-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="#E6EEF3" stroke-opacity="0.18" stroke-width="1.5" fill="none"/><path d="M12 7v6l4 2" stroke="#E6EEF3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/></svg>
                        </div>
                        <div class="stat-value">—</div>
                        <div class="stat-label">应用总使用时间</div>
                    </div>
                    <div class="stat-card stat-orange" id="stat-top-app">
                        <div class="stat-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l2.4 4.8L20 9.2l-4 3.6L17.2 20 12 16.8 6.8 20 8 12.8 4 9.2l5.6-1.4L12 3z" fill="#E6EEF3" opacity="0.18"/></svg>
                        </div>
                        <div class="stat-value">—</div>
                        <div class="stat-label">最常用应用</div>
                    </div>
                    <div class="stat-card stat-purple" id="stat-top-hour">
                        <div class="stat-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12h18" stroke="#E6EEF3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.18"/><path d="M7 8v8" stroke="#E6EEF3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/><path d="M12 6v12" stroke="#E6EEF3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/></svg>
                        </div>
                        <div class="stat-value">—</div>
                        <div class="stat-label">最活跃时段</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-main">
                <section class="panel devices-panel">
                    <div class="panel-header">
                        <div>
                            <p class="eyebrow">设备列表</p>
                            <h4>实时状态</h4>
                        </div>
                        <button class="ghost-btn" id="refresh-devices" aria-label="刷新设备状态">
                            <span class="btn-icon" aria-hidden="true">⟳</span> 刷新
                        </button>
                    </div>
                    <aside class="devices-list" id="devices-list" role="list" aria-label="设备列表">
                        {%- for id, dev in devices.items() %}
                        {% set status_class = 'status-running' if dev.using else ('status-standby' if dev.app_name and '待机' in dev.app_name else 'status-stopped') %}
                        {% set status_label = '运行中' if dev.using else ('待机' if dev.app_name and '待机' in dev.app_name else '已停止') %}
                        <div class="device-box {{ status_class }}" data-id="{{ id }}" role="listitem" tabindex="0">
                            <div class="device-box-head">
                                <div>
                                    <div class="device-title">{{ dev.show_name }}</div>
                                    <div class="device-sub">ID: {{ id }}</div>
                                </div>
                                <span class="status-chip {{ status_class }}">{{ status_label }}</span>
                            </div>
                            <div class="device-meta-row">
                                <div class="device-app-line">{{ dev.app_name if dev.app_name else '暂无运行应用' }}</div>
                                <div class="battery-inline">
                                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><rect x="2" y="7" width="18" height="10" rx="2" ry="2" stroke="currentColor" stroke-width="1.6" fill="none"></rect><rect x="20" y="10" width="2" height="4" rx="1" fill="currentColor"></rect><rect x="4" y="9" width="12" height="6" rx="1" fill="currentColor" opacity="0.18"></rect></svg>
                                    <span>{% if dev.battery_percent is not none %}{{ dev.battery_percent }}{% if '%' not in dev.battery_percent|string %}%{% endif %}{% else %}—%{% endif %}</span>
                                </div>
                                <button class="expand-toggle" aria-expanded="false" aria-label="展开设备详情">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9l6 6 6-6" stroke="#E6EEF3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                            <div id="expand-{{ id }}" class="card-expand-body" aria-hidden="true"></div>
                        </div>
                        {%- endfor %}
                    </aside>
                </section>

                <section class="panel analytics-panel charts" id="main-charts">
                    <div class="charts-top">
                        <div class="chart-card" id="donut-card"><div id="donut-root">加载中...</div></div>
                        <div class="chart-card" id="hourly-card"><div id="hourly-root">加载中...</div></div>
                    </div>
                    <div class="charts-bottom">
                        <div class="chart-card" id="progress-list-card"><h4>详细使用数据</h4><div id="progress-list">加载中...</div></div>
                        <div class="chart-card" id="recent-table-card"><h4>最近使用记录</h4><div id="recent-table">加载中...</div></div>
                    </div>
                </section>
            </div>

            <div class="action-row">
                <button onclick="handleButton1Click()" class="dg-btn"><img src="https://dungeon-lab.cn/img/logo-new.png" alt="DG-LAB" class="text-icon">雷元素攻击！</button>
            </div>

            {% if env.util.steam_enabled %}
            <!-- (steam) Steam 状态模块 (iframe) -->
            {% include "steam.html" %}
            {% endif %}

            <p id="last-updated">最后更新: {{ last_updated }}</p>
        </div>

        {% if zhixue %}
        <!-- (zhixue) 智学网分数 -->
        {% include "zhixue.html" %}
        {% endif %}

        <div class="card dashboard-card secondary-card" id="more_text">
            {% if env.page.hitokoto %}
            <!-- (hitokoto) 一言 -->
            {% include "hitokoto.html" %}
            {% endif %}
            <!-- more_text START -->
            {{ more_text | safe }}
            <!-- more_text END -->
            <p>你可以通过这个页面视奸 <b>{{ env.page.user }}</b>。<br>
                <a href="{{ env.page.repo }}" target="_blank" style="color: rgb(0, 255, 0);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width:1em;">
                        <path
                            d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z" />
                    </svg>
                    <!-- learn_more START -->
                    {{ env.page.learn_more | safe }}
                    <!-- learn_more END -->
                </a>
            </p>
        </div>
    </div>

    {% if env.page.lantern %}
    <!-- (lantern) 节日灯笼 -->
    {% include "lantern.html" %}
    {% endif %}

    {% if env.page.mplayer %}
    <!-- (mplayer) 音乐播放器 -->
    {% include "mplayer.html" %}
    {% endif %}

    {% if env.page.canvas %}
    <!-- (canvas) 粒子效果 -->
    <script src="{{ url_for('static', filename='canvas.js') }}" defer></script>
    {% endif %}

    <script>
    <!-- Modal / popover placeholders (created dynamically by JS when needed) -->
    <div id="modals" aria-hidden="true"></div>
        document.getElementById('status').classList.add("{{ status['color'] }}");
        
        // 初始化DG-Lab按钮状态
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.querySelector('.dg-btn');
            if (button) {
                // 默认设置为连续点击模式
                button.dataset.continuousClick = 'true';
                button.dataset.processing = 'false';
                
                // 尝试获取配置
                fetch('/dglab/config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data && typeof data.continuous_click !== 'undefined') {
                        button.dataset.continuousClick = data.continuous_click.toString();
                    }
                })
                .catch(error => {
                    console.error('无法获取配置:', error);
                });
            }
        });
        
        // DG-Lab 雷元素攻击按钮处理函数
        function handleButton1Click() {
            // 显示加载状态
            const button = document.querySelector('.dg-btn');
            const originalText = button.innerHTML;
            
            // 检查是否已经有一个请求正在处理
            if (button.dataset.processing === 'true') {
                return; // 如果按钮正在处理中，不执行任何操作
            }
            
            // 标记按钮为处理中
            button.dataset.processing = 'true';
            
            // 在非连续点击模式下显示"发送中..."
            // 在连续点击模式下不改变按钮文本
            const isContinuousClick = button.dataset.continuousClick === 'true';
            if (!isContinuousClick) {
                button.innerHTML = '发送中...';
                button.disabled = true;
            }
            
            // 创建结果显示区域（如果不存在）
            let resultDiv = document.getElementById('attack-result');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'attack-result';
                resultDiv.style.margin = '10px 0';
                resultDiv.style.padding = '10px';
                resultDiv.style.borderRadius = '8px';
                resultDiv.style.fontWeight = 'bold';
                button.parentNode.insertBefore(resultDiv, button.nextSibling);
            }
            
            // 发送请求
            fetch('/dglab/lightning', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // 显示结果
                if (data.success) {
                    // 成功消息
                    resultDiv.style.backgroundColor = 'rgba(0, 128, 0, 0.2)';
                    resultDiv.style.color = '#006400';
                    resultDiv.innerHTML = `<div>${data.message}</div>`;
                    if (data.details) {
                        resultDiv.innerHTML += `<div style="font-size: 0.9em; margin-top: 5px;">${data.details}</div>`;
                    }
                    
                    // 获取持续时间（毫秒）
                    let displayDuration = 0;
                    
                    // 如果API返回了实际发送的数据，直接使用
                    if (data.data_sent && data.data_sent.time) {
                        displayDuration = data.data_sent.time;
                    } else {
                        // 否则从详情文本中提取
                        const detailsText = data.details || '';
                        const durationMatch = detailsText.match(/持续: (\d+)秒/);
                        if (durationMatch && durationMatch[1]) {
                            displayDuration = parseInt(durationMatch[1]) * 1000; // 转换为毫秒
                        } else {
                            displayDuration = 3000; // 默认3秒
                        }
                    }
                    
                    // 设置定时器，在持续时间结束后隐藏结果
                    setTimeout(() => {
                        // 使用淡出动画
                        resultDiv.style.opacity = '0';
                        setTimeout(() => {
                            resultDiv.innerHTML = '';
                            resultDiv.style.backgroundColor = 'transparent';
                            resultDiv.style.opacity = '1';
                        }, 500);
                    }, displayDuration);
                    
                    // 更新按钮的连续点击状态
                    button.dataset.continuousClick = data.continuous_click.toString();
                    
                    // 在连续点击模式下不显示"攻击成功"
                    if (!data.continuous_click) {
                        button.innerHTML = '⚡ 攻击成功！';
                    } else {
                        button.innerHTML = originalText;
                        button.disabled = false; // 确保按钮在连续点击模式下不被禁用
                    }
                    
                    // 处理连续点击控制
                    if (!data.continuous_click && data.cooldown_time > 0) {
                        // 如果不允许连续点击，显示冷却时间
                        let cooldownSeconds = data.cooldown_time;
                        button.disabled = true;
                        button.style.opacity = '0.6';
                        button.style.cursor = 'not-allowed';
                        
                        // 创建冷却计时器
                        const cooldownInterval = setInterval(() => {
                            cooldownSeconds--;
                            button.innerHTML = `冷却中 (${cooldownSeconds}s)`;
                            
                            if (cooldownSeconds <= 0) {
                                clearInterval(cooldownInterval);
                                button.innerHTML = originalText;
                                button.disabled = false;
                                button.style.opacity = '1';
                                button.style.cursor = 'pointer';
                                button.dataset.processing = 'false'; // 重置处理状态
                            }
                        }, 1000);
                        
                        return; // 提前返回，不执行后面的恢复按钮状态代码
                    }
                } else {
                    // 失败消息
                    button.innerHTML = '❌ 攻击失败！';
                    resultDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                    resultDiv.style.color = '#8B0000';
                    resultDiv.innerHTML = data.message;
                    console.error('Error:', data.message);
                    
                    // 3秒后隐藏失败消息
                    setTimeout(() => {
                        resultDiv.style.opacity = '0';
                        setTimeout(() => {
                            resultDiv.innerHTML = '';
                            resultDiv.style.backgroundColor = 'transparent';
                            resultDiv.style.opacity = '1';
                        }, 500);
                    }, 3000);
                }
                
                // 恢复按钮状态（仅在连续点击模式或失败时执行）
                if (data.continuous_click) {
                    // 连续点击模式下立即恢复按钮状态
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.dataset.processing = 'false'; // 重置处理状态
                } else {
                    // 非连续点击模式下延迟恢复
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.dataset.processing = 'false'; // 重置处理状态
                    }, 2000);
                }
            })
            .catch(error => {
                button.innerHTML = '发生错误！';
                resultDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                resultDiv.style.color = '#8B0000';
                resultDiv.innerHTML = '系统错误，请稍后再试';
                console.error('Error:', error);
                
                // 3秒后隐藏错误消息
                setTimeout(() => {
                    resultDiv.style.opacity = '0';
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                        resultDiv.style.backgroundColor = 'transparent';
                        resultDiv.style.opacity = '1';
                    }, 500);
                }, 3000);
                
                // 错误情况下立即恢复按钮状态
                button.innerHTML = originalText;
                button.disabled = false;
                button.dataset.processing = 'false'; // 重置处理状态
            });
        }
    </script>
    <script src="{{ url_for('static', filename='get.js') }}" defer></script>

</body>

</html>